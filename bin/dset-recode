#!/usr/bin/env python2
# encoding: utf-8
"""
Re-encode the dataset.

Usage:
  dset-recode [options] <ifname> <ofname>

Options
  -n <len>, --blocklength <len>    Block length [default: 1000]
  -c <comp>, --compression <comp>  Compression method [default: lz4]
  -s <fmt>, --serializer <fmt>     Serializer method [default: msgpack]
"""

from docopt import docopt

from pypb.dset import read_preheader, open as open_latest
from pypb.dset_v1 import open as open_v1
from pypb.dset_v2 import open as open_v2

def main():
    args = docopt(__doc__)

    blocklength = args["--blocklength"]
    blocklength = int(blocklength)

    compression = args["--compression"]
    serializer = args["--serializer"]
    ifname = args["<ifname>"]
    ofname = args["<ofname>"]

    params = {
        "block_length": blocklength,
        "compression": compression,
        "serializer": serializer,
    }

    with open(ifname) as fobj:
        version, _ = read_preheader(fobj)
        if version == 1:
            opener = open_v1
        elif version == 2:
            opener = open_v2
        else:
            opener = open_latest

    with opener(ifname) as din:
        with open_latest(ofname, "w", **params) as dout:
            dout.extend(din)

if __name__ == '__main__':
    main()
