#!/usr/bin/env python2
# encoding: utf-8
"""
Covert a list of msgpack files to dset
"""

from __future__ import division, print_function, unicode_literals

import sys
import gzip

import msgpack
import pypb.dset

def main():
    fnames = sys.argv[1:]
    if len(fnames) < 2:
        print("Usage: msgpacks2dset [ifname]... ofname")
        sys.exit(1)

    ifnames = fnames[:-1]
    ofname = fnames[-1]

    params = {"block_length": 1000, "compression": "zlib"}
    with pypb.dset.open(ofname, "w", **params) as dset:
        for ifname in ifnames:
            with gzip.open(ifname) as fin:
                unpacker = msgpack.Unpacker(fin, encoding="utf-8")
                dset.extend(unpacker)

if __name__ == '__main__':
    main()
